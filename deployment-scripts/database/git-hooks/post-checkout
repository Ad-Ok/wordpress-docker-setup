#!/bin/bash
# ๐ Git Post-Checkout Hook
# ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะบะปััะตะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั ะฟัะธ ัะผะตะฝะต ะฒะตัะพะบ

# ะญัะพั hook ะฒัะทัะฒะฐะตััั ะฟะพัะปะต 'git checkout'
# $1 = ะฟัะตะดัะดััะธะน HEAD
# $2 = ะฝะพะฒัะน HEAD
# $3 = ัะปะฐะณ (1 = ะฟะตัะตะบะปััะตะฝะธะต ะฒะตัะพะบ, 0 = ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ัะฐะนะปะพะฒ)

PREV_HEAD="$1"
NEW_HEAD="$2"
BRANCH_CHECKOUT="$3"

# ะัะพะฟัััะธัั ะตัะปะธ ััะพ ะฝะต ะฟะตัะตะบะปััะตะฝะธะต ะฒะตัะพะบ
if [ "$BRANCH_CHECKOUT" != "1" ]; then
    exit 0
fi

# ะฆะฒะตัะฐ
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# ะะพะปััะธัั ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
DEPLOYMENT_SCRIPTS="${PROJECT_ROOT}/www/deployment-scripts"

# ะัะพะฒะตัะธัั, ัััะตััะฒััั ะปะธ ัะบัะธะฟัั ะะ
if [ ! -f "${DEPLOYMENT_SCRIPTS}/database/db-snapshot.sh" ]; then
    exit 0
fi

# ะะฐะณััะทะธัั ะบะพะฝัะธะณััะฐัะธั
if [ ! -f "${DEPLOYMENT_SCRIPTS}/config.sh" ]; then
    exit 0
fi

source "${DEPLOYMENT_SCRIPTS}/config.sh"

# ะัะพะฒะตัะธัั, ะฒะบะปััะตะฝะพ ะปะธ ะฐะฒัะพะฟะตัะตะบะปััะตะฝะธะต
if [ "$SNAPSHOT_AUTO_SWITCH" != "true" ]; then
    exit 0
fi

# ะะพะปััะธัั ะฝะฐะทะฒะฐะฝะธั ะฒะตัะพะบ
PREV_BRANCH=$(git name-rev --name-only "$PREV_HEAD" 2>/dev/null | sed 's/^remotes\/origin\///')
NEW_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# ะัะพะฟัััะธัั ะดะปั ัะปัะถะตะฑะฝัั ะพะฟะตัะฐัะธะน
if [ "$PREV_BRANCH" == "undefined" ] || [ "$NEW_BRANCH" == "HEAD" ]; then
    exit 0
fi

echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ะะตัะตะบะปััะตะฝะธะต ะฒะตัะพะบ: ${YELLOW}${PREV_BRANCH}${NC} โ ${GREEN}${NEW_BRANCH}${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

# 1. ะกะพััะฐะฝะธัั ัะตะบัััั ะะ
echo -e "\n${CYAN}[1/2] ะกะพััะฐะฝะตะฝะธะต ะะ ะฒะตัะบะธ: ${YELLOW}${PREV_BRANCH}${NC}"
"${DEPLOYMENT_SCRIPTS}/database/db-snapshot.sh" auto-save

# 2. ะะพัััะฐะฝะพะฒะธัั ะะ ะดะปั ะฝะพะฒะพะน ะฒะตัะบะธ
echo -e "\n${CYAN}[2/2] ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะะ ะดะปั: ${GREEN}${NEW_BRANCH}${NC}"
"${DEPLOYMENT_SCRIPTS}/database/db-snapshot.sh" auto-restore "${NEW_BRANCH}"

echo -e "\n${GREEN}โ ะะตัะตะบะปััะตะฝะธะต ะทะฐะฒะตััะตะฝะพ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

exit 0
