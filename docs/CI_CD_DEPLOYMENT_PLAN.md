# üöÄ CI/CD –∏ Deployment Plan –¥–ª—è your-domain.com

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–¥–µ–ø–ª–æ—è)
2. [–ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#–º–∏–≥—Ä–∞—Ü–∏–∏-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
3. [CI/CD Pipeline](#cicd-pipeline)
4. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ö–æ—Å—Ç–∏–Ω–≥—É](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∫-—Ö–æ—Å—Ç–∏–Ω–≥—É)
5. [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–µ–ø–ª–æ—è](#—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–¥–µ–ø–ª–æ—è)
6. [Rollback –ø–ª–∞–Ω](#rollback-–ø–ª–∞–Ω)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è

### –û–∫—Ä—É–∂–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   LOCAL     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ     DEV     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  PRODUCTION ‚îÇ
‚îÇ  (Docker)   ‚îÇ     ‚îÇ  (—Å–µ—Ä–≤–µ—Ä)   ‚îÇ     ‚îÇ   (—Å–µ—Ä–≤–µ—Ä)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**LOCAL:**
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤ Docker
- –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: MySQL 8.0 –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

**DEV:**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º
- –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –∏–∑ –≤–µ—Ç–∫–∏ `dev`
- –ë–∞–∑–∞: –∫–æ–ø–∏—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)
- –î–æ–º–µ–Ω: `dev.your-domain.com` –∏–ª–∏ `your-domain.com/dev/`

**PRODUCTION:**
- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç
- –î–µ–ø–ª–æ–π –∏–∑ –≤–µ—Ç–∫–∏ `main` –ø–æ—Å–ª–µ —Ä–µ–≤—å—é
- –ë–∞–∑–∞: Production MySQL
- –î–æ–º–µ–Ω: `your-domain.com`

---

## üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–±–ª–µ–º–∞
WordPress –Ω–µ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î, –∫–∞–∫ Laravel –∏–ª–∏ Django.

### –†–µ—à–µ–Ω–∏–µ: Custom Migration System

#### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```
wp-content/
  migrations/
    001_clean_old_plugins.sql
    002_fix_category_slugs.sql
    003_rename_cpt_sobitiya_to_events.sql
    004_rename_cpt_vistavki_to_exhibitions.sql
    005_migrate_pods_to_acf.sql
    006_add_artist_fields.sql
    007_create_photo_cpt.sql
    migration_runner.php
    .applied_migrations
```

#### 2. –§–æ—Ä–º–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

```sql
-- Migration: 002_fix_category_slugs.sql
-- Description: Fix URL-encoded category slugs
-- Author: Dev Team
-- Date: 2025-10-24

-- === UP ===
UPDATE wp_terms SET slug = 'zhivopis' WHERE term_id = 19 AND slug = '%D0%B6%D0%B8%D0%B2%D0%BE%D0%BF%D0%B8%D1%81%D1%8C';
UPDATE wp_terms SET slug = 'soyuz-khudozhnikov' WHERE term_id = 22 AND slug = '%D1%81%D0%BE%D1%8E%D0%B7-%D1%85%D1%83%D0%B4%D0%BE%D0%B6%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2';
UPDATE wp_terms SET slug = 'portret' WHERE term_id = 23 AND slug = '%D0%BF%D0%BE%D1%80%D1%82%D1%80%D0%B5%D1%82';

-- Flush rewrite rules (marker for PHP runner)
-- @flush_rewrite_rules

-- === DOWN ===
-- Rollback not recommended (SEO impact)
-- Keep old slugs in redirects table instead
```

#### 3. Migration Runner (WP-CLI –∫–æ–º–∞–Ω–¥–∞)

```php
<?php
// wp-content/migrations/migration_runner.php

class Maslovka_Migration_Runner {
    
    private $migrations_dir;
    private $applied_file;
    
    public function __construct() {
        $this->migrations_dir = WP_CONTENT_DIR . '/migrations';
        $this->applied_file = $this->migrations_dir . '/.applied_migrations';
    }
    
    /**
     * Run pending migrations
     */
    public function migrate() {
        $pending = $this->get_pending_migrations();
        
        if (empty($pending)) {
            WP_CLI::success('No pending migrations');
            return;
        }
        
        foreach ($pending as $migration) {
            WP_CLI::log("Running: {$migration}");
            
            try {
                $this->run_migration($migration);
                $this->mark_as_applied($migration);
                WP_CLI::success("‚úì {$migration}");
            } catch (Exception $e) {
                WP_CLI::error("‚úó {$migration}: " . $e->getMessage());
                break; // Stop on first error
            }
        }
    }
    
    /**
     * Get list of pending migrations
     */
    private function get_pending_migrations() {
        $applied = $this->get_applied_migrations();
        $all = $this->get_all_migrations();
        
        return array_diff($all, $applied);
    }
    
    /**
     * Run single migration file
     */
    private function run_migration($file) {
        global $wpdb;
        
        $sql = file_get_contents($this->migrations_dir . '/' . $file);
        
        // Extract UP section
        preg_match('/-- === UP ===(.*?)(?:-- === DOWN ===|$)/s', $sql, $matches);
        $up_sql = trim($matches[1]);
        
        // Check for special markers
        $flush_rewrite = strpos($sql, '@flush_rewrite_rules') !== false;
        
        // Split by semicolon and execute
        $queries = array_filter(
            array_map('trim', explode(';', $up_sql)),
            function($q) {
                return !empty($q) && substr($q, 0, 2) !== '--';
            }
        );
        
        foreach ($queries as $query) {
            $result = $wpdb->query($query);
            if ($result === false) {
                throw new Exception($wpdb->last_error);
            }
        }
        
        // Execute post-migration actions
        if ($flush_rewrite) {
            flush_rewrite_rules();
        }
    }
    
    /**
     * Get applied migrations from file
     */
    private function get_applied_migrations() {
        if (!file_exists($this->applied_file)) {
            return [];
        }
        return array_filter(explode("\n", file_get_contents($this->applied_file)));
    }
    
    /**
     * Get all migration files
     */
    private function get_all_migrations() {
        $files = glob($this->migrations_dir . '/*.sql');
        return array_map('basename', $files);
    }
    
    /**
     * Mark migration as applied
     */
    private function mark_as_applied($migration) {
        file_put_contents(
            $this->applied_file,
            $migration . "\n",
            FILE_APPEND
        );
    }
    
    /**
     * Show migration status
     */
    public function status() {
        $applied = $this->get_applied_migrations();
        $all = $this->get_all_migrations();
        $pending = array_diff($all, $applied);
        
        WP_CLI::log("\nMigration Status:\n");
        
        foreach ($all as $migration) {
            $status = in_array($migration, $applied) ? '‚úì' : '‚úó';
            WP_CLI::log("{$status} {$migration}");
        }
        
        WP_CLI::log("\n" . count($applied) . " applied, " . count($pending) . " pending\n");
    }
}

// Register WP-CLI command
if (defined('WP_CLI') && WP_CLI) {
    WP_CLI::add_command('your-project migrate', function($args, $assoc_args) {
        $runner = new Maslovka_Migration_Runner();
        $runner->migrate();
    });
    
    WP_CLI::add_command('your-project migrate:status', function($args, $assoc_args) {
        $runner = new Maslovka_Migration_Runner();
        $runner->status();
    });
}
```

#### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CI/CD

```yaml
# –í deploy —Å–∫—Ä–∏–ø—Ç–µ:
- name: Run database migrations
  run: |
    ssh $SERVER "cd $WEBROOT && wp your-project migrate:status"
    ssh $SERVER "cd $WEBROOT && wp your-project migrate"
```

#### 5. –†–µ–¥–∏—Ä–µ–∫—Ç—ã (301) –¥–ª—è SEO

```php
<?php
// wp-content/mu-plugins/your-project-redirects.php
// Must-use plugin for redirects

add_action('init', 'your_project_handle_redirects', 1);

function your_project_handle_redirects() {
    $request_uri = $_SERVER['REQUEST_URI'];
    
    // Map old slugs to new
    $redirects = [
        // Old category slugs
        '/category/%D0%B6%D0%B8%D0%B2%D0%BE%D0%BF%D0%B8%D1%81%D1%8C/' => '/category/zhivopis/',
        '/category/%D1%81%D0%BE%D1%8E%D0%B7-%D1%85%D1%83%D0%B4%D0%BE%D0%B6%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2/' => '/category/soyuz-khudozhnikov/',
        '/category/%D0%BF%D0%BE%D1%80%D1%82%D1%80%D0%B5%D1%82/' => '/category/portret/',
        
        // Old CPT slugs
        '/sobitiya/' => '/events/',
        '/vistavki/' => '/exhibitions/',
    ];
    
    // Check for matches (with and without trailing slash)
    foreach ($redirects as $old => $new) {
        if (
            strpos($request_uri, $old) === 0 ||
            strpos($request_uri, rtrim($old, '/')) === 0
        ) {
            wp_redirect($new . substr($request_uri, strlen($old)), 301);
            exit;
        }
    }
}
```

---

## üîÑ CI/CD Pipeline

### GitHub Actions Workflow

```yaml
# .github/workflows/deploy.yml
name: Deploy your-domain.com

on:
  push:
    branches:
      - main        # Production
      - dev         # Development
  pull_request:
    branches:
      - main

env:
  PHP_VERSION: '8.3'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # 1. TESTS & VALIDATION
  # ============================================
  test:
    name: Tests & Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mysqli, mbstring, xml, gd
          tools: composer, wp-cli
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install PHP dependencies
        run: |
          cd www/wordpress/wp-content/themes/your-theme
          composer install --no-interaction
      
      - name: Install Node dependencies
        run: |
          cd www/wordpress/wp-content/themes/your-theme
          npm ci
      
      - name: PHP Lint
        run: find www/wordpress/wp-content/themes/your-theme -name "*.php" -exec php -l {} \;
      
      - name: Build assets
        run: |
          cd www/wordpress/wp-content/themes/your-theme
          npm run build
      
      - name: Check migration syntax
        run: |
          for file in www/wordpress/wp-content/migrations/*.sql; do
            echo "Checking $file"
            # Simple syntax check (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
            grep -q "-- === UP ===" "$file" || exit 1
          done

  # ============================================
  # 2. BUILD ASSETS
  # ============================================
  build:
    name: Build Theme Assets
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          cd www/wordpress/wp-content/themes/your-theme
          npm ci
      
      - name: Build production assets
        run: |
          cd www/wordpress/wp-content/themes/your-theme
          npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: theme-assets
          path: |
            www/wordpress/wp-content/themes/your-theme/assets/css/
            www/wordpress/wp-content/themes/your-theme/assets/js/
          retention-days: 7

  # ============================================
  # 3. DEPLOY TO DEV
  # ============================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    environment:
      name: development
      url: https://dev.your-domain.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: theme-assets
          path: www/wordpress/wp-content/themes/your-theme/
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEV_SSH_KEY }}
      
      - name: Add server to known hosts
        run: ssh-keyscan -H ${{ secrets.DEV_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy files via rsync
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='wp-content/uploads' \
            --exclude='wp-content/cache' \
            --exclude='.env' \
            www/wordpress/ \
            ${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:${{ secrets.DEV_WEBROOT }}/
      
      - name: Run migrations
        run: |
          ssh ${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }} << 'EOF'
            cd ${{ secrets.DEV_WEBROOT }}
            wp your-project migrate:status
            wp your-project migrate
          EOF
      
      - name: Clear cache
        run: |
          ssh ${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }} << 'EOF'
            cd ${{ secrets.DEV_WEBROOT }}
            wp cache flush
            wp super-cache flush
          EOF
      
      - name: Notify on success
        if: success()
        run: |
          curl -X POST ${{ secrets.TELEGRAM_WEBHOOK }} \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚úÖ DEV deployed successfully: ${{ github.sha }}"

  # ============================================
  # 4. DEPLOY TO PRODUCTION
  # ============================================
  deploy-prod:
    name: Deploy to PRODUCTION
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://your-domain.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: theme-assets
          path: www/wordpress/wp-content/themes/your-theme/
      
      # === BACKUP BEFORE DEPLOY ===
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}
      
      - name: Add server to known hosts
        run: ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create database backup
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            cd ${{ secrets.PROD_WEBROOT }}
            BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).sql.gz"
            wp db export - | gzip > ../backups/$BACKUP_FILE
            echo "Backup created: $BACKUP_FILE"
            
            # Keep only last 10 backups
            cd ../backups
            ls -t backup-*.sql.gz | tail -n +11 | xargs -r rm
          EOF
      
      - name: Create files backup
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            cd ${{ secrets.PROD_WEBROOT }}/..
            BACKUP_FILE="files-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf backups/$BACKUP_FILE \
              --exclude='wp-content/cache' \
              --exclude='wp-content/uploads' \
              html/wp-content/themes/your-theme
            echo "Files backup created: $BACKUP_FILE"
          EOF
      
      # === DEPLOY ===
      - name: Enable maintenance mode
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            cd ${{ secrets.PROD_WEBROOT }}
            wp maintenance-mode activate
          EOF
      
      - name: Deploy files via rsync
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='wp-content/uploads' \
            --exclude='wp-content/cache' \
            --exclude='.env' \
            www/wordpress/ \
            ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_WEBROOT }}/
      
      - name: Run migrations
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            cd ${{ secrets.PROD_WEBROOT }}
            wp your-project migrate:status
            wp your-project migrate
          EOF
      
      - name: Clear cache
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            cd ${{ secrets.PROD_WEBROOT }}
            wp cache flush
            wp super-cache flush
          EOF
      
      - name: Disable maintenance mode
        if: always()
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            cd ${{ secrets.PROD_WEBROOT }}
            wp maintenance-mode deactivate
          EOF
      
      # === SMOKE TESTS ===
      - name: Smoke test - Check homepage
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://your-domain.com)
          if [ "$STATUS" != "200" ]; then
            echo "Homepage returned $STATUS"
            exit 1
          fi
      
      - name: Smoke test - Check API
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://your-domain.com/wp-json/)
          if [ "$STATUS" != "200" ]; then
            echo "API returned $STATUS"
            exit 1
          fi
      
      # === NOTIFICATIONS ===
      - name: Notify on success
        if: success()
        run: |
          curl -X POST ${{ secrets.TELEGRAM_WEBHOOK }} \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚úÖ PRODUCTION deployed successfully: ${{ github.sha }}"
      
      - name: Notify on failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.TELEGRAM_WEBHOOK }} \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üö® PRODUCTION deployment FAILED: ${{ github.sha }}"
```

---

## üñ•Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ö–æ—Å—Ç–∏–Ω–≥—É

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –ó–∞—á–µ–º |
|-----------|-----------|-------|
| **PHP** | 8.3+ | –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π WordPress + performance |
| **MySQL** | 8.0+ | JSON support, better performance |
| **Nginx/Apache** | –õ—é–±–æ–π | –í–µ–±-—Å–µ—Ä–≤–µ—Ä |
| **Disk Space** | 10 GB | –°–∞–π—Ç (5GB) + –±—ç–∫–∞–ø—ã (5GB) |
| **RAM** | 512 MB | –ú–∏–Ω–∏–º—É–º –¥–ª—è PHP-FPM |
| **SSH –¥–æ—Å—Ç—É–ø** | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –î–ª—è –¥–µ–ø–ª–æ—è –∏ WP-CLI |
| **WP-CLI** | –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω | –î–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ |
| **Git** | –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | –î–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

### –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è

‚ùå Docker (–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –æ–±—ã—á–Ω–æ–º LAMP/LEMP)  
‚ùå Root –¥–æ—Å—Ç—É–ø  
‚ùå Composer –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Å–æ–±–∏—Ä–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ)  
‚ùå Node.js –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Å–æ–±–∏—Ä–∞–µ–º –≤ CI/CD)  
‚ùå –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ë–î  
‚ùå Load balancer  
‚ùå Redis/Memcached (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```
/home/user/
  ‚îú‚îÄ‚îÄ html/                          # Webroot
  ‚îÇ   ‚îú‚îÄ‚îÄ .htaccess                  # Permalinks
  ‚îÇ   ‚îú‚îÄ‚îÄ index.php
  ‚îÇ   ‚îú‚îÄ‚îÄ wp-config.php              # –ö–æ–Ω—Ñ–∏–≥ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  ‚îÇ   ‚îú‚îÄ‚îÄ wp-content/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ themes/your-theme/       # –ù–∞—à–∞ —Ç–µ–º–∞
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ plugins/               # –ü–ª–∞–≥–∏–Ω—ã
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ uploads/               # –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ git
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache/                 # –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ git
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/            # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mu-plugins/            # Must-use –ø–ª–∞–≥–∏–Ω—ã (—Ä–µ–¥–∏—Ä–µ–∫—Ç—ã)
  ‚îÇ   ‚îî‚îÄ‚îÄ ...
  ‚îú‚îÄ‚îÄ backups/                       # –ë—ç–∫–∞–ø—ã (–≤–Ω–µ webroot!)
  ‚îÇ   ‚îú‚îÄ‚îÄ backup-20251024-120000.sql.gz
  ‚îÇ   ‚îú‚îÄ‚îÄ backup-20251023-120000.sql.gz
  ‚îÇ   ‚îî‚îÄ‚îÄ files-20251024-120000.tar.gz
  ‚îî‚îÄ‚îÄ logs/                          # –õ–æ–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è wp-config.php –¥–ª—è –¥–µ–ø–ª–æ—è

```php
<?php
// wp-config.php

// === Database ===
define('DB_NAME', getenv('DB_NAME') ?: 'your_project_prod');
define('DB_USER', getenv('DB_USER') ?: 'your_project_user');
define('DB_PASSWORD', getenv('DB_PASSWORD'));
define('DB_HOST', getenv('DB_HOST') ?: 'localhost');
define('DB_CHARSET', 'utf8mb4');
define('DB_COLLATE', '');

// === Environment ===
define('WP_ENVIRONMENT_TYPE', getenv('WP_ENV') ?: 'production');

// === Security Keys === 
// (–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ https://api.wordpress.org/secret-key/1.1/salt/)
define('AUTH_KEY',         getenv('AUTH_KEY'));
define('SECURE_AUTH_KEY',  getenv('SECURE_AUTH_KEY'));
// ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏

// === Debug (—Ç–æ–ª—å–∫–æ –¥–ª—è dev) ===
if (WP_ENVIRONMENT_TYPE === 'development') {
    define('WP_DEBUG', true);
    define('WP_DEBUG_LOG', true);
    define('WP_DEBUG_DISPLAY', false);
} else {
    define('WP_DEBUG', false);
}

// === Performance ===
define('WP_MEMORY_LIMIT', '256M');
define('WP_MAX_MEMORY_LIMIT', '512M');
define('DISABLE_WP_CRON', true); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å system cron

// === URLs ===
define('WP_HOME', getenv('WP_HOME') ?: 'https://your-domain.com');
define('WP_SITEURL', getenv('WP_SITEURL') ?: 'https://your-domain.com');

// === File System ===
define('FS_METHOD', 'direct'); // –î–ª—è rsync –¥–µ–ø–ª–æ—è

$table_prefix = 'wp_';

require_once ABSPATH . 'wp-settings.php';
```

### .env —Ñ–∞–π–ª (–ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—å!)

```bash
# .env (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
DB_NAME=your_project_prod
DB_USER=your_project_user
DB_PASSWORD=secure_password_here
DB_HOST=localhost

WP_ENV=production
WP_HOME=https://your-domain.com
WP_SITEURL=https://your-domain.com

AUTH_KEY='...'
SECURE_AUTH_KEY='...'
# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏
```

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–µ–ø–ª–æ—è

### 1. –ü–µ—Ä–≤–∏—á–Ω—ã–π –¥–µ–ø–ª–æ–π (–æ–¥–∏–Ω —Ä–∞–∑)

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
cd /home/user

# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–∏–ª–∏ –∑–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ FTP)
git clone https://github.com/yourorg/your-project.git html

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WP-CLI (–µ—Å–ª–∏ –Ω–µ—Ç)
curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
chmod +x wp-cli.phar
sudo mv wp-cli.phar /usr/local/bin/wp

# 3. –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫–∏
mkdir -p backups logs

# 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∞
chmod 755 html
chmod 644 html/wp-config.php
chown -R www-data:www-data html/wp-content/uploads
chown -R www-data:www-data html/wp-content/cache

# 5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env
nano html/.env  # –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

# 6. –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
wp db import backup.sql

# 7. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
wp your-project migrate

# 8. –û–±–Ω–æ–≤–∏—Ç—å URL –≤ –±–∞–∑–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
wp search-replace 'http://old-domain.com' 'https://your-domain.com'

# 9. Flush permalinks
wp rewrite flush

# 10. –°–æ–∑–¥–∞—Ç—å cron –¥–ª—è wp-cron
crontab -e
# –î–æ–±–∞–≤–∏—Ç—å:
# */5 * * * * wp --path=/home/user/html cron event run --due-now
```

### 2. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –¥–µ–ø–ª–æ–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ CI/CD)

1. Push –≤ `dev` ‚Üí –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –Ω–∞ dev —Å–µ—Ä–≤–µ—Ä
2. PR –≤ `main` ‚Üí —Ç–µ—Å—Ç—ã
3. Merge –≤ `main` ‚Üí –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –Ω–∞ production

### 3. –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ:
cd www/wordpress/wp-content/themes/your-theme
npm run build

# –î–µ–ø–ª–æ–π:
rsync -avz --delete \
  --exclude='.git' \
  --exclude='node_modules' \
  --exclude='wp-content/uploads' \
  --exclude='wp-content/cache' \
  www/wordpress/ \
  user@server:/home/user/html/

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
ssh user@server
cd /home/user/html
wp your-project migrate
wp cache flush
```

---

## ‚Ü©Ô∏è Rollback Plan

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ

```yaml
# –í GitHub Actions:
- name: Rollback on failure
  if: failure()
  run: |
    ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
      cd ${{ secrets.PROD_WEBROOT }}/..
      
      # Restore files
      LATEST_FILE_BACKUP=$(ls -t backups/files-*.tar.gz | head -1)
      tar -xzf backups/$LATEST_FILE_BACKUP -C html/
      
      # Restore database
      LATEST_DB_BACKUP=$(ls -t backups/backup-*.sql.gz | head -1)
      gunzip -c backups/$LATEST_DB_BACKUP | wp db import -
      
      wp cache flush
      wp maintenance-mode deactivate
    EOF
```

### –†—É—á–Ω–æ–π rollback

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
cd /home/user

# 1. –í–∫–ª—é—á–∏—Ç—å maintenance mode
wp maintenance-mode activate

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã
BACKUP_DATE="20251024-120000"  # –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—É—é –¥–∞—Ç—É
tar -xzf backups/files-$BACKUP_DATE.tar.gz -C html/

# 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É
gunzip -c backups/backup-$BACKUP_DATE.sql.gz | wp db import -

# 4. –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ .applied_migrations
nano html/wp-content/migrations/.applied_migrations

# 5. –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à
wp cache flush
wp super-cache flush

# 6. –í—ã–∫–ª—é—á–∏—Ç—å maintenance mode
wp maintenance-mode deactivate
```

---

## üì¶ GitHub Secrets (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)

```
# Development
DEV_SSH_KEY          # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á
DEV_HOST             # –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
DEV_USER             # SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
DEV_WEBROOT          # –ü—É—Ç—å –∫ webroot (/home/user/html)

# Production
PROD_SSH_KEY         # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á
PROD_HOST            # –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
PROD_USER            # SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  
PROD_WEBROOT         # –ü—É—Ç—å –∫ webroot (/home/user/html)

# Notifications
TELEGRAM_WEBHOOK     # URL –≤–µ–±—Ö—É–∫–∞ Telegram
TELEGRAM_CHAT_ID     # ID —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

---

## ‚è±Ô∏è –í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è |
|--------|-------|
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π | 2 —á |
| –ù–∞–ø–∏—Å–∞–Ω–∏–µ migration runner | 2 —á |
| –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π (SQL) | 2 —á |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Actions | 2 —á |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ (dev + prod) | 1 —á |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–ø–ª–æ—è | 2 —á |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 1 —á |
| **–ò–¢–û–ì–û** | **12 —á** |

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

### –õ–æ–∫–∞–ª—å–Ω–æ:
- [ ] –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π
- [ ] –ù–∞–ø–∏—Å–∞–Ω migration runner
- [ ] –í—Å–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω GitHub Actions workflow
- [ ] –î–æ–±–∞–≤–ª–µ–Ω .gitignore –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö:
- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω PHP 8.3
- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω MySQL 8.0
- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω WP-CLI
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω SSH –¥–æ—Å—Ç—É–ø
- [ ] –°–æ–∑–¥–∞–Ω—ã –ø–∞–ø–∫–∏ backups/ –∏ logs/
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –ø–∞–ø–∫–∏
- [ ] –°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

### –í GitHub:
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ Secrets
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è (dev, production)
- [ ] –í–∫–ª—é—á–µ–Ω—ã branch protection rules –¥–ª—è main

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ dev
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ rollback
- [ ] Smoke tests –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üéØ –ò—Ç–æ–≥

**–ß—Ç–æ –ø–æ–ª—É—á–∞–µ–º:**
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –∏–∑ git  
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–ø–ª–æ–µ–º  
‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å rollback –∑–∞ –º–∏–Ω—É—Ç—É  
‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ö–æ—Å—Ç–∏–Ω–≥—É  
‚úÖ Zero-downtime –¥–µ–ø–ª–æ–π (maintenance mode –Ω–∞ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥)  
‚úÖ Smoke tests –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è  
‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥:**
- –ü—Ä–æ—Å—Ç–æ–π shared hosting / VPS
- PHP 8.3 + MySQL 8.0 + SSH + WP-CLI
- 10 GB –º–µ—Å—Ç–∞
- –ë–µ–∑ Docker, –±–µ–∑ root, –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
